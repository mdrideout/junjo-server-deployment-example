# Caddyfile for Junjo Local Dev & Production Deployment

# This Caddyfile uses the JUNJO_PROD_AUTH_DOMAIN environment variable to define
# the production domain. Set this in your .env file.
# Example: JUNJO_PROD_AUTH_DOMAIN=junjo-deploy.example.rideout.dev

# ---------------------------
# Local Development Server (localhost)
# ---------------------------
# This block is ONLY for local development access to Jaeger.
localhost {
    log

    @jaegerPath path /jaeger*
    handle @jaegerPath {
        # Validate jaeger requests with the backend auth service
        forward_auth junjo-server-backend:1323 {
            uri /auth-test
            copy_headers Cookie
        }

        # On auth failure, redirect to the local frontend for sign-in
        @bad status 4xx
        handle_response @bad {
            redir http://localhost:5153/sign-in 302
        }

        # If auth succeeds, proxy to the Jaeger UI
        reverse_proxy junjo-jaeger:16686
    }

    # Note: Other local services are accessed directly by their ports,
    # so no other handlers are needed here.
}


# ---------------------------
# Production API Server (api.{$JUNJO_PROD_AUTH_DOMAIN})
# ---------------------------
api.{$JUNJO_PROD_AUTH_DOMAIN} {
    log
    # CORS is handled by the backend application.
    reverse_proxy junjo-server-backend:1323
}

# ---------------------------
# Production gRPC Server (grpc.{$JUNJO_PROD_AUTH_DOMAIN})
# ---------------------------
grpc.{$JUNJO_PROD_AUTH_DOMAIN} {
    log
    # The h2c scheme enables gRPC over HTTP/2.
    reverse_proxy h2c://junjo-server-backend:50051
}

# ---------------------------
# Production Frontend & Jaeger UI ({$JUNJO_PROD_AUTH_DOMAIN})
# ---------------------------
{$JUNJO_PROD_AUTH_DOMAIN} {
    log

    # Handle Jaeger UI requests with forward authentication.
    handle_path /jaeger/* {
        forward_auth junjo-server-backend:1323 {
            uri /auth-test
            copy_headers Cookie
        }

        # On auth failure, redirect to the production sign-in page.
        @bad status 4xx
        handle_response @bad {
            redir https://{$JUNJO_PROD_AUTH_DOMAIN}/sign-in 302
        }

        # If auth succeeds, proxy to the Jaeger UI.
        reverse_proxy junjo-jaeger:16686
    }

    # Handle all other requests by serving the frontend application.
    handle {
        reverse_proxy junjo-server-frontend:80
    }
}
