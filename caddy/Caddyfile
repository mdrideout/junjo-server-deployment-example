:80 {
    log

    map {host} {redirect_url} {
        # For production host
        junjo-deploy.example.rideout.dev https://junjo-deploy.example.rideout.dev/sign-in
        # Default for all other hosts (i.e., localhost)
        default http://localhost:5153/sign-in
    }

    @jaegerPath path /jaeger*

    handle @jaegerPath {
        # Validate all jaeger requests with the backend auth service (validates cookies)
        forward_auth junjo-server-backend:1323 {
            uri /auth-test
            copy_headers Cookie

            # Redirect to the FE app sign-in page if the auth service returns a 4xx status
            @bad status 4xx
			handle_response @bad {
                # Utilize the map
				redir {redirect_url} 302
			}
        }

        # If auth succeeds (200 response), continue the request to the Jaeger UI.
        reverse_proxy junjo-jaeger:16686 {
            header_up Host {upstream_hostport}
        }
    }
}
